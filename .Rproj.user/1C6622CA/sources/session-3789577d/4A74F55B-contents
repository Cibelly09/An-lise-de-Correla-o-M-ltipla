# --- 24/08
getwd()

# CARREGANDO BASES 

dados_acm<- read.csv("data/perfil_eleitor_red.csv", sep = ",", header = TRUE, stringsAsFactors = TRUE)



# Mostra as primeiras linhas do data frame
head(dados_acm)  

# Mostra a estrutura do data frame
str(dados_acm) 

# Padroniza os nomes (tudo maiúsculo)
names(dados_acm) <- toupper(names(dados_acm))

# Remove linhas com NA (caso existam)
dados_acm <- na.omit(dados_acm)

# Instalação e carregamento dos pacotes utilizados
pacotes <- c("plotly", 
             "tidyverse", 
             "ggrepel",
             "ggplot2",
             "knitr", "kableExtra", 
             "sjPlot", 
             "FactoMineR", 
             "amap", 
             "ade4",
             "readxl")

# Carregando todos
if(sum(as.numeric(!pacotes %in% installed.packages())) != 0){
  instalador <- pacotes[!pacotes %in% installed.packages()]
  for(i in 1:length(instalador)) {
    install.packages(instalador, dependencies = T)
    break()}
  sapply(pacotes, require, character = T) 
} else {
  sapply(pacotes, require, character = T) 
}


# A função para a criação da ACM pede que sejam utilizados "fatores"
dados_acm <- as.data.frame(unclass(dados_acm), stringsAsFactors=TRUE)

# Tabelas de contingência (todas apresentam associação com alguma variável?)
sjt.xtab(var.row = dados_acm $DS_TIPO_DEFICIENCIA,
         var.col = dados_acm $DS_GENERO,
         show.exp = TRUE,
         show.row.prc = TRUE,
         show.col.prc = TRUE, 
         encoding = "UTF-8")

sjt.xtab(var.row = dados_acm $DS_TIPO_DEFICIENCIA,
         var.col = dados_acm $DS_FAIXA_ETARIA,
         show.exp = TRUE,
         show.row.prc = TRUE,
         show.col.prc = TRUE, 
         encoding = "UTF-8")

sjt.xtab(var.row = dados_acm $DS_TIPO_DEFICIENCIA,
         var.col = dados_acm $DS_RACA_COR,
         show.exp = TRUE,
         show.row.prc = TRUE,
         show.col.prc = TRUE, 
         encoding = "UTF-8")


sjt.xtab(var.row = dados_acm $DS_TIPO_DEFICIENCIA,
         var.col = dados_acm $DS_GRAU_ESCOLARIDADE,
         show.exp = TRUE,
         show.row.prc = TRUE,
         show.col.prc = TRUE, 
         encoding = "UTF-8")



sjt.xtab(var.row = dados_acm $DS_TIPO_DEFICIENCIA,
         var.col = dados_acm $DS_ESTADO_CIVIL,
         show.exp = TRUE,
         show.row.prc = TRUE,
         show.col.prc = TRUE, 
         encoding = "UTF-8")

sjt.xtab(var.row = dados_acm $DS_TIPO_DEFICIENCIA,
         var.col = dados_acm $SG_UF,
         show.exp = TRUE,
         show.row.prc = TRUE,
         show.col.prc = TRUE, 
         encoding = "UTF-8")

sjt.xtab(var.row = dados_acm $DS_TIPO_DEFICIENCIA,
         var.col = dados_acm $REGIAO,
         show.exp = TRUE,
         show.row.prc = TRUE,
         show.col.prc = TRUE, 
         encoding = "UTF-8")

# Vamos gerar a ACM
ACM <- dudi.acm(dados_acm, scannf = FALSE)

# Analisando as variâncias de cada dimensão (tirando os autovalores)
perc_variancia <- (ACM$eig / sum(ACM$eig)) * 100
paste0(round(perc_variancia,2),"%")

# Quantidade de categorias por variável
quant_categorias <- apply(dados_acm,
                          MARGIN =  2,
                          FUN = function(x) nlevels(as.factor(x)))


# Consolidando as coordenadas-padrão obtidas por meio da matriz binária
#(puxando as coordenadas das 2 primeiras dimensoes)

df_ACM <- data.frame(ACM$c1, Variável = rep(names(quant_categorias),
                                            quant_categorias))

# Plotando o mapa perceptual
grafico_acm <- df_ACM %>%
  rownames_to_column() %>%
  rename(Categoria = 1) %>%
  ggplot(aes(x = CS1, y = CS2, label = Categoria, color = Variável)) +
  geom_point() +
  geom_label_repel() +
  geom_vline(aes(xintercept = 0), linetype = "longdash", color = "grey48") +
  geom_hline(aes(yintercept = 0), linetype = "longdash", color = "grey48") +
  labs(
    title = "Mapa Perceptual - Análise de Correspondência Múltipla",
    x = paste("Dimensão 1:", paste0(round(perc_variancia[1], 2), "%")),
    y = paste("Dimensão 2:", paste0(round(perc_variancia[2], 2), "%"))
  ) +
  theme_bw()


str(grafico_acm)

print(grafico_acm)


ggsave("output/mapa_acm_perfil.png", grafico_acm, width = 10, height = 8, dpi = 300)

#################################################################333

# REFINANDO O MAPA PARA CONSEGUIR VER OS TIPOS DE DEF

# Exemplo de como destacar variáveis específicas no ggplot (como tipos de deficiência)
library(ggplot2)

colnames(df_ACM)

# Análise da variabilidade para determinar o número de clusters com o método do cotovelo
wss <- (nrow(df_ACM)-1)*sum(apply(df_ACM, 2, var))
for (i in 2:10) wss[i] <- sum(kmeans(df_ACM, centers=i)$withinss)

# Plotar o gráfico do cotovelo
plot(1:10, wss, type="b", xlab="Número de Clusters", ylab="Soma dos Erros Quadrados")

# Após determinar o número ideal, aplicar o K-means
set.seed(123) # para reprodutibilidade
kmeans_result <- kmeans(df_ACM, centers=ideal_clusters)

# Plotar os resultados
plot(df_ACM, col=kmeans_result$cluster, pch=20, cex=2)
########################################################################


#
# Filtrar variáveis relevantes
dados_filtro <- dados_acm[, c('SG_UF', 'QT_ELEITORES_DEFICIENCIA', 'QT_LOCAIS_ACESSIVEIS', 'CD_GENERO', 'CD_FAIXA_ETARIA')]



# GERANDO UM MAPA 3D PARA VERIFICAR A PROFUNDIDADE DOS DADOS 

# Criando a ACM
ACM <- dudi.acm(dados_acm, scannf = FALSE, nf = 3)

## Foram extraídas as coordenadas para 3 dimensões: nf = 3
## O intuito é plotar um gráfico tridimensional

# Analisando as variâncias de cada dimensão
perc_variancia <- (ACM$eig / sum(ACM$eig)) * 100
paste0(round(perc_variancia,2),"%")

# Quantidade de categorias por variável
quant_categorias <- apply(dados_acm,
                          MARGIN =  2,
                          FUN = function(x) nlevels(as.factor(x)))

# Consolidando as coordenadas obtidas por meio da matriz binária
df_ACM <- data.frame(ACM$c1, Variável = rep(names(quant_categorias),
                                            quant_categorias))

# Mapa perceptual em 3D (3 primeiras dimensões)
ACM_3D <- plot_ly()

# Adicionando as coordenadas
ACM_3D <- add_trace(p = ACM_3D,
                    x = df_ACM$CS1,
                    y = df_ACM$CS2,
                    z = df_ACM$CS3,
                    mode = "text",
                    text = rownames(df_ACM),
                    textfont = list(color = "blue"),
                    marker = list(color = "red"),
                    showlegend = FALSE)

ACM_3D


# Fim!

# --------------------------------AQUI ACABOU A ANALISE OFICIAL EXPLICADA -----

# Poderíamos fazer o mapa com as coordenadas obtidas por meio da matriz de Burt

# Consolidando as coordenadas-padrão obtidas por meio da matriz de Burt
df_ACM_burt <- data.frame(ACM$co, Variável = rep(names(quant_categorias),
                                              quant_categorias))
# -- salvando os df com todas as coordenadas

write.csv(df_ACM_burt, "output/ACM_COORDENADAS.csv", row.names = FALSE) 

# Plotando o mapa perceptual
df_ACM_burt %>%
  rownames_to_column() %>%
  rename(Categoria = 1) %>%
  ggplot(aes(x = Comp1, y = Comp2, label = Categoria, color = Variável)) +
  geom_point() +
  geom_label_repel() +
  geom_vline(aes(xintercept = 0), linetype = "longdash", color = "grey48") +
  geom_hline(aes(yintercept = 0), linetype = "longdash", color = "grey48") +
  labs(x = paste("Dimensão 1:", paste0(round(perc_variancia[1], 2), "%")),
       y = paste("Dimensão 2:", paste0(round(perc_variancia[2], 2), "%"))) +
  theme_bw()

# É possível obter as coordenadas das observações
df_coord_obs <- ACM$li

# -- salvando os df
write.csv(df_coord_obs, "output/df_acm_burt.csv", row.names = FALSE) 

# Plotando o mapa perceptual para genero
df_coord_obs %>%
  ggplot(aes(x = Axis1, y = Axis2, color = df_ACM_burt$DS_GENERO)) +
  geom_point() +
  geom_vline(aes(xintercept = 0), linetype = "longdash", color = "grey48") +
  geom_hline(aes(yintercept = 0), linetype = "longdash", color = "grey48") +
  labs(x = paste("Dimensão 1:", paste0(round(perc_variancia[1], 2), "%")),
       y = paste("Dimensão 2:", paste0(round(perc_variancia[2], 2), "%")),
       color = "Gênero") +
  theme_bw()

# plotando para faixa etária 
df_coord_obs %>%
  ggplot(aes(x = Axis1, y = Axis2, color = df_ACM_burt$DS_TIPO_DEFICIENCIA)) +
  geom_point() +
  geom_vline(aes(xintercept = 0), linetype = "longdash", color = "grey48") +
  geom_hline(aes(yintercept = 0), linetype = "longdash", color = "grey48") +
  labs(x = paste("Dimensão 1:", paste0(round(perc_variancia[1], 2), "%")),
       y = paste("Dimensão 2:", paste0(round(perc_variancia[2], 2), "%")),
       color = "DS_FAIXA_ETARIA") +
  theme_bw()

# Plotando o mapa perceptual para grau de escolaridade

df_coord_obs %>%
  ggplot(aes(x = Axis1, y = Axis2, color = dados_fat$DS_GRAU_ESCOLARIDADE)) +
  geom_point() +
  geom_vline(aes(xintercept = 0), linetype = "longdash", color = "grey48") +
  geom_hline(aes(yintercept = 0), linetype = "longdash", color = "grey48") +
  labs(x = paste("Dimensão 1:", paste0(round(perc_variancia[1], 2), "%")),
       y = paste("Dimensão 2:", paste0(round(perc_variancia[2], 2), "%")),
       color = "DS_GRAU_ESCOLARIDADE") +
  theme_bw()

# Plotando o mapa perceptual para estado civil

df_coord_obs %>%
  ggplot(aes(x = Axis1, y = Axis2, color = dados_fat$DS_ESTADO_CIVIL)) +
  geom_point() +
  geom_vline(aes(xintercept = 0), linetype = "longdash", color = "grey48") +
  geom_hline(aes(yintercept = 0), linetype = "longdash", color = "grey48") +
  labs(x = paste("Dimensão 1:", paste0(round(perc_variancia[1], 2), "%")),
       y = paste("Dimensão 2:", paste0(round(perc_variancia[2], 2), "%")),
       color = "DS_ESTADO_CIVIL") +
  theme_bw()


# Plotando o mapa perceptual para raça

df_coord_obs %>%
  ggplot(aes(x = Axis1, y = Axis2, color = dados_fat$DS_RACA_COR)) +
  geom_point() +
  geom_vline(aes(xintercept = 0), linetype = "longdash", color = "grey48") +
  geom_hline(aes(yintercept = 0), linetype = "longdash", color = "grey48") +
  labs(x = paste("Dimensão 1:", paste0(round(perc_variancia[1], 2), "%")),
       y = paste("Dimensão 2:", paste0(round(perc_variancia[2], 2), "%")),
       color = "DS_RACA_COR") +
  theme_bw()

# plotando para estados só para ver 
df_coord_obs %>%
  ggplot(aes(x = Axis1, y = Axis2, color = dados_fat$SG_UF)) +
  geom_point() +
  geom_vline(aes(xintercept = 0), linetype = "longdash", color = "grey48") +
  geom_hline(aes(yintercept = 0), linetype = "longdash", color = "grey48") +
  labs(x = paste("Dimensão 1:", paste0(round(perc_variancia[1], 2), "%")),
       y = paste("Dimensão 2:", paste0(round(perc_variancia[2], 2), "%")),
       color = "Estados") +
  theme_bw()
# não fez sentido com os estados

# -- salvando os df
write.csv(acm_red_filtered, "output/nova_base.csv", row.names = FALSE)